(function(b){var a=new function(){var c=this;c.width=ko.observable(b("#main").outerWidth());var d=function(){var e=this;e.oldHostname="";e.serialize=function(){return{id:e.id(),hostname:e.hostname(),port:e.port(),enableSSL:e.enableSSL()?1:0,enableAuthentication:e.enableAuthentication()?1:0,username:e.username(),password:e.password()}};e.update=function(){if(!a.mailservers.loading){if(e.hostname.isValid()){e.editing(false);if(e.port.isValid()){if(!e.enableAuthentication()){if(e.username().length>0){e.usernameSubscription.dispose();e.username("");e.usernameSubscription=e.username.subscribe(e.update)}if(e.password().length>0){e.passwordSubscription.dispose();e.password("");e.passwordSubscription=e.password.subscribe(e.update)}}else{if(!(e.username.isValid()&&e.password.isValid())){return}}if(!e.id()){b.ajax({url:"../../admin/mailservers/create",data:e.serialize(),type:"POST",dataType:"json",timeout:30000,success:function(g,h,f){e.id(g.id)},error:MMONIT.error.json});a.mailservers.createInProgress(false)}else{b.ajax({url:"../../admin/mailservers/update",data:e.serialize(),type:"POST",timeout:30000,error:MMONIT.error.json})}if(a.mailservers.expandedRow()){e.test()}}else{a.mailservers.expandedRow(e);b("#mailserver"+e.id()+" .mailPort").focus()}}else{e.editing(true)}}};e.test=function(){if(e.hostname().length>0&&e.port()>0){if(e.testInProgress&&e.testInProgress.readyState!=4){e.testInProgress.abort()}e.showTestResult(true);var f=b("#mailserver"+e.id()+" .testResult .accessory");f.html("<img src='../../img/spinner_small.gif' height='16' width='16' />");e.testInProgress=b.ajax({url:"../../admin/mailservers/test",data:e.serialize(),type:"POST",dataType:"json",timeout:30000,success:function(h,i,g){f.css("color",h.status==0?"red":"green");f.text(h.description)},error:function(g,i,h){if(i==="timeout"){f.css("color","red");f.text("Test timed out")}else{if(i!=="abort"){MMONIT.error.json(g,i,h)}}}})}};e.edit=function(f,g){g.stopPropagation();e.oldHostname=e.hostname();e.editing(true)};e.stopEdit=function(){if(b.trim(e.hostname()).length>0){if(e.oldHostname!==e.hostname()){e.oldHostname=e.hostname();e.update()}else{e.editing(false)}}};e.toggleSSL=function(f,g){g.stopPropagation();e.enableSSL(!e.enableSSL())};e.toggleAuthentication=function(f,g){g.stopPropagation();e.enableAuthentication(!e.enableAuthentication())};e.id=ko.observable(null);e.hostname=ko.observable("").extend({required:true,maxLength:255});e.port=ko.observable().extend({required:true,number:true,min:1,max:65535,step:1});e.enableSSL=ko.observable(false);e.enableAuthentication=ko.observable(false);e.username=ko.observable("").extend({required:true,maxLength:255});e.password=ko.observable("").extend({required:true,maxLength:255});e.editing=ko.observable(false);e.showTestResult=ko.observable(false);e.mouseover=ko.observable(ISTABLET);e.portSubscription=e.port.subscribe(e.update);e.enableSSLSubscription=e.enableSSL.subscribe(e.update);e.enableAuthenticationSubscription=e.enableAuthentication.subscribe(e.update);e.usernameSubscription=e.username.subscribe(e.update);e.passwordSubscription=e.password.subscribe(e.update)};c.mailservers={loading:true,list:ko.observableArray(),mailserver:ko.observable(),expandedRow:ko.observable(),createInProgress:ko.observable(false),toggleExpand:function(g,f){f.stopPropagation();c.mailservers.expandedRow((c.mailservers.expandedRow()!==g)?g:null);if(c.mailservers.expandedRow()){g.test()}},isExpanded:function(e){return(e===c.mailservers.expandedRow())},enableMouseover:function(g,f){f.stopPropagation();if(!ISTABLET){g.mouseover(true)}},disableMouseover:function(g,f){f.stopPropagation();if(!ISTABLET){g.mouseover(false)}},confirmDelete:function(g,f){f.stopPropagation();c.mailservers.mailserver(g);b("#confirmMailserverDelete").modal("show")},add:function(g,h){h.stopPropagation();if(!c.mailservers.createInProgress()){c.mailservers.createInProgress(true);c.mailservers.expandedRow(null);var f=new d();f.editing(true);c.mailservers.list.push(f)}},remove:function(g,f){f.stopPropagation();if(g.id()>0){b.ajax({url:"../../admin/mailservers/delete",data:{id:g.id()},type:"POST",timeout:30000,success:function(h,i,e){b("#confirmMailserverDelete").modal("hide");c.mailservers.list.remove(g)},error:function(e,i,h){b("#confirmMailserverDelete").modal("hide");MMONIT.error.json(e,i,h)}})}else{b("#confirmMailserverDelete").modal("hide");c.mailservers.createInProgress(false);c.mailservers.list.remove(g)}}};b.getJSON("../../admin/mailservers/list",function(g){for(var e=0;e<g.length;e++){var f=new d();f.id(g[e].id);f.hostname(g[e].hostname);f.port(g[e].port);f.enableSSL(g[e].enableSSL?true:false);f.enableAuthentication(g[e].username!=""&&g[e].password!=""?true:false);f.username(g[e].username);f.password(g[e].password);c.mailservers.list.push(f)}c.mailservers.loading=false}).error(MMONIT.error.json)};ko.validation.init({insertMessages:false,decorateElement:true,errorElementClass:"error"},true);ko.applyBindings(a,document.getElementById("mailTab"));b(window).on("resize orientationchange",function(c){a.width(b("#main").outerWidth())})})(jQuery);