(function(b){var a=new function(){var c=this;c.width=ko.observable(b("#main").outerWidth());var d=function(){var e=this;e.oldHostname="";e.serialize=function(){return{id:e.id(),hostname:e.hostname(),port:e.port(),username:e.username(),password:e.password()}};e.update=function(){if(!a.jabberservers.loading){if(e.hostname.isValid()){e.editing(false);if(e.port.isValid()&&e.username.isValid()&&e.password.isValid()){if(!e.id()){b.ajax({url:"../../admin/jabberservers/create",data:e.serialize(),type:"POST",dataType:"json",timeout:30000,success:function(g,h,f){e.id(g.id)},error:MMONIT.error.json});a.jabberservers.createInProgress(false)}else{b.ajax({url:"../../admin/jabberservers/update",data:e.serialize(),type:"POST",timeout:30000,error:MMONIT.error.json})}if(a.jabberservers.expandedRow()){e.test()}}else{a.jabberservers.expandedRow(e);if(!e.port.isValid()){b("#jabberserver"+e.id()+" .jabberPort").focus()}}}else{e.editing(true)}}};e.test=function(){if(e.hostname().length>0&&e.port()>0){if(e.testInProgress&&e.testInProgress.readyState!=4){e.testInProgress.abort()}e.showTestResult(true);var f=b("#jabberserver"+e.id()+" .testResult .accessory");f.html("<img src='../../img/spinner_small.gif' height='16' width='16' />");e.testInProgress=b.ajax({url:"../../admin/jabberservers/test",data:e.serialize(),type:"POST",dataType:"json",timeout:30000,success:function(h,i,g){f.css("color",h.status==0?"red":"green");f.text(h.description)},error:function(g,i,h){if(i==="timeout"){f.css("color","red");f.text("Test timed out")}else{if(i!=="abort"){MMONIT.error.json(g,i,h)}}}})}};e.edit=function(f,g){g.stopPropagation();e.oldHostname=e.hostname();e.editing(true)};e.stopEdit=function(){if(b.trim(e.hostname()).length>0){if(e.oldHostname!==e.hostname()){e.oldHostname=e.hostname();e.update()}else{e.editing(false)}}};e.id=ko.observable(null);e.hostname=ko.observable("").extend({required:true,maxLength:255});e.port=ko.observable().extend({required:true,number:true,min:1,max:65535,step:1});e.username=ko.observable("").extend({required:true,maxLength:255});e.password=ko.observable("").extend({required:true,maxLength:255});e.editing=ko.observable(false);e.showTestResult=ko.observable(false);e.mouseover=ko.observable(ISTABLET);e.portSubscription=e.port.subscribe(e.update);e.usernameSubscription=e.username.subscribe(e.update);e.passwordSubscription=e.password.subscribe(e.update)};c.jabberservers={loading:true,list:ko.observableArray(),jabberserver:ko.observable(),expandedRow:ko.observable(),createInProgress:ko.observable(false),toggleExpand:function(g,f){f.stopPropagation();c.jabberservers.expandedRow((c.jabberservers.expandedRow()!==g)?g:null);if(c.jabberservers.expandedRow()){g.test()}},isExpanded:function(e){return(e===c.jabberservers.expandedRow())},enableMouseover:function(g,f){f.stopPropagation();if(!ISTABLET){g.mouseover(true)}},disableMouseover:function(g,f){f.stopPropagation();if(!ISTABLET){g.mouseover(false)}},confirmDelete:function(g,f){f.stopPropagation();c.jabberservers.jabberserver(g);b("#confirmJabberserverDelete").modal("show")},add:function(g,h){h.stopPropagation();if(!c.jabberservers.createInProgress()){c.jabberservers.createInProgress(true);c.jabberservers.expandedRow(null);var f=new d();f.editing(true);c.jabberservers.list.push(f)}},remove:function(g,f){f.stopPropagation();if(g.id()>0){b.ajax({url:"../../admin/jabberservers/delete",data:{id:g.id()},type:"POST",timeout:30000,success:function(h,i,e){b("#confirmJabberserverDelete").modal("hide");c.jabberservers.list.remove(g)},error:function(e,i,h){b("#confirmJabberserverDelete").modal("hide");MMONIT.error.json(e,i,h)}})}else{b("#confirmJabberserverDelete").modal("hide");c.jabberservers.createInProgress(false);c.jabberservers.list.remove(g)}}};b.getJSON("../../admin/jabberservers/list",function(g){for(var e=0;e<g.length;e++){var f=new d();f.id(g[e].id);f.hostname(g[e].hostname);f.port(g[e].port);f.username(g[e].username);f.password(g[e].password);c.jabberservers.list.push(f)}c.jabberservers.loading=false}).error(MMONIT.error.json)};ko.validation.init({insertMessages:false,decorateElement:true,errorElementClass:"error"},true);ko.applyBindings(a,document.getElementById("jabberTab"));b(window).on("resize orientationchange",function(c){a.width(b("#main").outerWidth())})})(jQuery);