(function(c){function b(d,g,e){var f="";c.each(g,function(h,i){if(i.id!="-1"&&i.selected()){f+=(f.length?"&":"")+d+"="+i[e]}});return f}var a=new function(){c.ajaxSettings.traditional=true;var e=this;e.width=ko.observable(c("#main").outerWidth());e.widthData=ko.observable(c("#data").width());e.isPhone=ko.computed(function(){return e.width()<768});e.widthColumnHost=ko.computed(function(){if(e.isPhone()){return 0}else{return(e.widthData()-120-60)/3}});e.widthColumnService=e.widthColumnHost;e.widthColumnEvent=ko.computed(function(){if(e.isPhone()){return e.widthData()-120-12}else{return(e.widthData()-120-60-18)/3}});e.datatable={sort:ko.observable("date"),dir:ko.observable("desc"),rowsperpage:ko.observable(15),startindex:ko.observable(0)};e.active=ko.observable(false);e.hosts=ko.observableArray();e.hostgroups=ko.observableArray();e.servicetypes=ko.observableArray();e.eventtypes=ko.observableArray();e.statetypes=ko.observableArray();e.datefrom=ko.observable();e.dateto=ko.observable();e._serviceCache=ko.observable("-1");e._servicegroupCache=ko.observable("-1");e.services=ko.computed(function(){var g=c.ajax({url:"../../map/service",type:"POST",dataType:"json",data:b("hostid",e.hosts(),"id")+b("hostgroupid",e.hostgroups(),"id"),async:false,error:MMONIT.error.json});if(g.state()!="resolved"){MMONIT.error.json(g);return[]}else{var f=c.parseJSON(g.responseText).map.service;f.unshift({id:"-1",name:"All Services"});var h=Menu.JSONToMenu(f);Menu.select(h,e._serviceCache());return h}}).extend({rateLimit:500});e.servicegroups=ko.computed(function(){var g=c.ajax({url:"../../map/servicegroup",type:"POST",dataType:"json",data:b("hostid",e.hosts(),"id")+b("hostgroupid",e.hostgroups(),"id"),async:false,error:MMONIT.error.json});if(g.state()!="resolved"){MMONIT.error.json(g);return[]}else{var f=c.parseJSON(g.responseText).map.servicegroup;f.unshift({id:"-1",name:"All Service Groups"});var h=Menu.JSONToMenu(f);Menu.select(h,e._servicegroupCache());return h}}).extend({rateLimit:500});e.hostgroupsLabel=ko.computed(function(){var f=Menu.getSelectedNames(e.hostgroups(),null);return f?f:"All"});e.servicesLabel=ko.computed(function(){var f=Menu.getSelectedNames(e.services(),null);return f?f:"All"});e.servicegroupsLabel=ko.computed(function(){var f=Menu.getSelectedNames(e.servicegroups(),null);return f?f:"All"});e.servicetypesLabel=ko.computed(function(){var f=Menu.getSelectedNames(e.servicetypes(),null);return f?f:"All"});e.eventtypesLabel=ko.computed(function(){var f=Menu.getSelectedNames(e.eventtypes(),null);return f?f:"All"});e.statetypesLabel=ko.computed(function(){var f=Menu.getSelectedNames(e.statetypes(),null);return f?f:"All"});e.datefromLabel=ko.computed(function(){var f;if(e.datefrom()){var g=new Date(e.datefrom()*1000);f="From "+g.toDateString().substr(4)}else{f="Date From"}return f});e.datetoLabel=ko.computed(function(){var f;if(e.dateto()){var g=new Date(e.dateto()*1000);f="To "+g.toDateString().substr(4)}else{f="Date To"}return f});e.toggleActive=function(g,f){e.active(!e.active());c("#events").trigger("reload").trigger("save")};e.selectHostgroup=function(f){Menu.select(e.hostgroups(),f.id);c("#events").trigger("reload").trigger("save")};e.selectService=function(f){e._serviceCache(f.id);Menu.select(e.services(),f.id);c("#events").trigger("reload").trigger("save")};e.selectServicegroup=function(f){e._servicegroupCache(f.id);Menu.select(e.servicegroups(),f.id);c("#events").trigger("reload").trigger("save")};e.selectServiceType=function(f){Menu.select(e.servicetypes(),f.id);c("#events").trigger("reload").trigger("save")};e.selectEventType=function(f){Menu.select(e.eventtypes(),f.id);c("#events").trigger("reload").trigger("save")};e.selectStateType=function(f){Menu.select(e.statetypes(),f.id);c("#events").trigger("reload").trigger("save")};e.resetDrilldown=function(){e._serviceCache("-1");e._servicegroupCache("-1");e.active(false);Menu.unselectAll(e.hosts());Menu.select(e.hostgroups(),"-1");Menu.select(e.services(),"-1");Menu.select(e.servicegroups(),"-1");Menu.select(e.servicetypes(),"-1");Menu.select(e.eventtypes(),"-1");Menu.select(e.statetypes(),"-1");c("#host").val("");e.hosts.valueHasMutated();e.hostgroups.valueHasMutated();c("#datefrom").datepicker("setValue",new Date());c("#dateto").datepicker("setValue",new Date());e.datefrom(null);e.dateto(null);e.datatable.sort("date");e.datatable.dir("desc");e.datatable.rowsperpage(15);e.datatable.startindex(0)};e.reset=function(){e.resetDrilldown();c("#events").trigger("reload").trigger("save")};e.filter=function(){var h=Menu.getSelectedValues(e.hosts(),"id");var k=Menu.getSelectedValues(e.hostgroups(),"id");var f=Menu.getSelectedValues(e.services(),"id");var i=Menu.getSelectedValues(e.servicegroups(),"id");var l=Menu.getSelectedValues(e.servicetypes(),"id");var j=Menu.getSelectedValues(e.eventtypes(),"id");var g=Menu.getSelectedValues(e.statetypes(),"id");return{active:e.active()?1:0,hostid:h.length?h:(c("#host").val()?"-1":null),hostgroupid:k=="-1"?null:k,servicenameid:f=="-1"?null:f,servicegroupid:i=="-1"?null:i,servicetype:l=="-1"?null:l,eventtype:j=="-1"?null:j,state:g=="-1"?null:g,datefrom:e.datefrom(),dateto:e.dateto(),sort:e.datatable.sort(),dir:e.datatable.dir(),results:e.datatable.rowsperpage(),startindex:e.datatable.startindex()}};e.init=function(){c.getJSON("../../session/get?key=active&key=host&key=hostgroupid&key=servicenameid&key=servicegroupid&key=servicetype&key=eventtype&key=state&key=datefrom&key=dateto&key=sort&key=dir&key=results&key=startindex",function(g){e.resetDrilldown();var f={reset:c(document).getUrlParam("reset"),active:c(document).getUrlParam("active"),host:c(document).getUrlParam("host"),hostgroup:c(document).getUrlParam("hostgroupid"),servicenameid:c(document).getUrlParam("servicenameid"),servicegroup:c(document).getUrlParam("servicegroupid"),servicetype:c(document).getUrlParam("servicetype"),eventtype:c(document).getUrlParam("eventtype"),state:c(document).getUrlParam("state"),datefrom:c(document).getUrlParam("datefrom"),dateto:c(document).getUrlParam("dateto"),sort:c(document).getUrlParam("sort"),dir:c(document).getUrlParam("dir"),results:c(document).getUrlParam("results"),startindex:c(document).getUrlParam("startindex")};if(f.reset){g={}}if(f.active==1||g.active==1){e.active(true)}if(f.host){c("#host").val(decodeURIComponent(f.host)).trigger("change")}else{if(g.host){c("#host").val(g.host).trigger("change")}}if(f.hostgroupid){Menu.select(e.hostgroups(),f.hostgroupid)}else{if(g.hostgroupid){Menu.select(e.hostgroups(),g.hostgroupid)}}if(f.servicenameid||g.servicenameid){e._serviceCache(f.servicenameid?f.servicenameid:g.servicenameid);Menu.select(e.services(),e._serviceCache())}if(f.servicegroupid||g.servicegroupid){e._servicegroupCache(f.servicegroupid?f.servicegroupid:g.servicegroupid);Menu.select(e.servicegroups(),e._servicegroupCache())}if(f.servicetype){Menu.select(e.servicetypes(),f.servicetype)}else{if(g.servicetype){Menu.select(e.servicetypes(),g.servicetype)}}if(f.eventtype){Menu.select(e.eventtypes(),f.eventtype)}else{if(g.eventtype){Menu.select(e.eventtypes(),g.eventtype)}}if(f.state){Menu.select(e.statetypes(),f.state)}else{if(g.state){Menu.select(e.statetypes(),g.state)}}if(f.datefrom||g.datefrom){e.datefrom(parseInt(f.datefrom?f.datefrom:g.datefrom));c("#datefrom").datepicker("setValue",new Date(e.datefrom()*1000))}if(f.dateto||g.dateto){e.dateto(parseInt(f.dateto?f.dateto:g.dateto));c("#dateto").datepicker("setValue",new Date(e.dateto()*1000))}if(f.sort){e.datatable.sort(f.sort)}else{if(g.sort){e.datatable.sort(g.sort)}}if(f.dir){e.datatable.dir(f.dir)}else{if(g.dir){e.datatable.dir(g.dir)}}if(f.results){e.datatable.rowsperpage(f.results)}else{if(g.results){e.datatable.rowsperpage(g.results)}}if(f.startindex){e.datatable.startindex(f.startindex)}else{if(g.startindex){e.datatable.startindex(g.startindex)}}c("#events").trigger("reload").trigger("save")}).error(MMONIT.error.json)};e.searchHostTimeout=null;e.searchHost=function(){var f=c("#host").val();if(f==""){Menu.unselectAll(e.hosts())}else{Menu.selectPattern(e.hosts(),f)}e.hosts.valueHasMutated();c("#events").trigger("reload").trigger("save")};c.getJSON("../../map",function(f){e.hosts(Menu.JSONMapToMenu(f.map.id.host).sort(Menu.sortByName));e.hostgroups(Menu.JSONMapToMenu(f.map.id.hostgroup).sort(Menu.sortByName));e.servicetypes(Menu.JSONMapToMenu(f.map.id.servicetype).sort(Menu.sortByName));e.eventtypes(Menu.JSONToMenu(f.map.event).sort(Menu.sortByName));e.statetypes(Menu.JSONMapToMenu(f.map.id.statetype).sort(Menu.sortByName));e.hostgroups.unshift(Menu.JSONToMenu([{id:"-1",name:"All Host Groups"}])[0]);e.servicetypes.unshift(Menu.JSONToMenu([{id:"-1",name:"All Service Types"}])[0]);e.eventtypes.unshift(Menu.JSONToMenu([{id:"-1",name:"All Event Types"}])[0]);e.statetypes.unshift(Menu.JSONToMenu([{id:"-1",name:"All State Types"}])[0]);c("#host").on("change input paste search",function(g){clearTimeout(e.searchHostTimeout);e.searchHostTimeout=setTimeout(e.searchHost,300)}).on("keyup",function(g){if(g.which==13){c(g.target).blur()}});c("#datefrom").datepicker({weekStart:1}).datepicker("setValue",new Date()).on("changeDate",function(g){e.datefrom(parseInt(g.date.valueOf())/1000);c("#events").trigger("reload").trigger("save")});c("#dateto").datepicker({weekStart:1}).datepicker("setValue",new Date()).on("changeDate",function(g){e.dateto(parseInt(g.date.valueOf())/1000);c("#events").trigger("reload").trigger("save")});e.init()}).error(MMONIT.error.json);var d=new YAHOO.util.YUILoader({base:"../../lib/f/yui/2/",loadOptional:false,require:["datasource","datatable","json","paginator"],onSuccess:function(){var k=function(t,s,u,v){c(t).text(strftime("%b %d %Y %H:%M:%S",new Date(s.getData("date")*1000)))};var q=function(t,s,u,v){c(t).html('<a href="../../status/hosts/detail?id='+s.getData("hostid")+'">'+YAHOO.lang.escapeHTML(s.getData("hostname"))+"</a>")};var g=function(t,s,u,v){if(s.getData("note")==1){c(t).html('<img src="../../img/note.png" alt="note">')}};var r=function(u,t,v,w){var s=t.getData("eventtype");if(s==1){u.style.color="red"}else{if(s==2||s==3){u.style.color="orange"}else{if(s==4||s==5){u.style.color="gray"}else{u.style.color="green"}}}c(u).text(t.getData("event"))};var j=function(u,t,v,w){var s=t.getData("eventtype");if(s==1){u.style.color="red"}else{if(s==2||s==3){u.style.color="orange"}else{if(s==4||s==5){u.style.color="gray"}else{u.style.color="green"}}}c(u).html("host "+t.getData("hostname")+" service "+t.getData("servicename")+": "+t.getData("event"))};var o=new YAHOO.util.XHRDataSource("../../reports/events/list");o.connMethodPost=true;o.connXhrMode="cancelStaleRequests";o.connTimeout=30000;o.responseType=YAHOO.util.XHRDataSource.TYPE_JSON;o.responseSchema={resultsList:"records",fields:["id","date","hostname","hostid","servicename","event","eventtype","note"],metaFields:{sort:"sort",dir:"dir",recordsReturned:"recordsReturned",pageSize:"pageSize",startIndex:"startIndex",totalRecords:"totalRecords"}};var f=[{key:"date",label:"Date",sortable:true,formatter:k},{key:"hostname",label:"Host",sortable:true,formatter:q,width:e.widthColumnHost()},{key:"servicename",label:"Service",sortable:true,formatter:"text",width:e.widthColumnService()},{key:"event",label:"Event",sortable:true,formatter:r,width:e.widthColumnEvent()},{key:"note",label:"Note",sortable:true,formatter:g}];var p=[{key:"date",label:"Date",sortable:true,formatter:k},{key:"event",label:"Event",sortable:true,formatter:j,width:e.widthColumnEvent()}];var l={alwaysVisible:false,containers:["pagingBottom"],pageLinks:7,rowsPerPage:e.datatable.rowsperpage(),rowsPerPageOptions:[15,30,60,100],template:"{PageLinks} {RowsPerPageDropdown}"};var h={alwaysVisible:false,containers:["pagingBottom"],rowsPerPage:e.datatable.rowsperpage(),template:"<div style='display:table;width:100%;'><div style='display:table-row;'><div style='display:table-cell;'>{PreviousPageLink}</div><div style='display:table-cell;text-align:center;'>{CurrentPageReport}</div><div style='display:table-cell;text-align:right;'>{NextPageLink}</div></div></div>"};var i={initialRequest:c.param(e.filter()),dynamicData:true,sortedBy:{key:e.datatable.sort(),dir:e.datatable.dir()},paginator:new YAHOO.widget.Paginator(e.isPhone()?h:l),generateRequest:function(u,t){var s=t.get("sortedBy");if(s){e.datatable.sort(s.key);e.datatable.dir(s.dir.replace("yui-dt-",""))}e.datatable.rowsperpage(u.pagination.rowsPerPage);e.datatable.startindex(u.pagination.recordOffset);return c.param(e.filter())}};var n=new YAHOO.widget.DataTable("events",e.isPhone()?p:f,o,i);n.doBeforeLoadData=function(t,s,u){if(s.error){MMONIT.error.json(s,null,null,n);return false}u.sortedBy={key:s.meta.sort,dir:"yui-dt-"+s.meta.dir};u.pagination.rowsPerPage=parseInt(s.meta.pageSize);u.pagination.recordOffset=parseInt(s.meta.startIndex);u.totalRecords=parseInt(s.meta.totalRecords);return true};n.sortColumn=function(v,u){if(v&&(v instanceof YAHOO.widget.Column)){if(!v.sortable){YAHOO.util.Dom.addClass(this.getThEl(v),YAHOO.widget.DataTable.CLASS_SORTABLE)}if(u&&(u!==YAHOO.widget.DataTable.CLASS_ASC)&&(u!==YAHOO.widget.DataTable.CLASS_DESC)){u=null}var t=u||this.getColumnSortDir(v);var w=this.get("sortedBy")||{};if(!(w.key===v.key&&w.dir===t)){this.initializeTable();this.set("sortedBy",{key:v.key,dir:t,column:v});var s=this.get("paginator");s.fireEvent("changeRequest",s.getState({page:1}));this.render();this.fireEvent("columnSortEvent",{column:v,dir:t})}}};if(!(ISPHONE||ISTABLET)){n.subscribe("rowMouseoverEvent",n.onEventHighlightRow);n.subscribe("rowMouseoutEvent",n.onEventUnhighlightRow)}n.subscribe("rowClickEvent",function(s){window.location=MMONIT.ui.location("details?id="+n.getRecord(s.target).getData("id"))});c("#events").on("reload",function(s){o.sendRequest(c.param(e.filter()),{success:n.onDataReturnReplaceRows,scope:n,argument:n.getState()})});i.paginator.subscribe("changeRequest",function(s){c("#events").trigger("reload").trigger("save")});c("#events").on("save",function(t){var s=e.filter();s.host=c("#host").val();c.post("../../session/put",c.param(s)).error(MMONIT.error.json)});(function m(){e.width(c("#main").outerWidth());e.widthData(c("#data").width());n.setColumnWidth(n.getColumn("hostname"),e.widthColumnHost());n.setColumnWidth(n.getColumn("servicename"),e.widthColumnService());n.setColumnWidth(n.getColumn("event"),e.widthColumnEvent());c(window).off("resize orientationchange").on("resize orientationchange",m)})()}});d.insert()};ko.applyBindings(a);c(document).on("vclick",function(d){c(".datepicker").hide()})})(jQuery);