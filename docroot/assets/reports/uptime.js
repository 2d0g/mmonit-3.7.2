var Report=function(){return{start:function(b){var a=new function(){var e=this;e.width=ko.observable($("#main").outerWidth());e.height=ko.observable($(window).outerHeight());e.isPhone=ko.computed(function(){return e.width()<768});e.isPortrait=ko.computed(function(){return e.width()<e.height()});e.widthColumnUp=ko.computed(function(){return 100});e.widthColumnDown=ko.computed(function(){return e.isPhone()&&e.isPortrait()?0:120});e.widthColumnEvents=ko.computed(function(){return e.isPhone()?0:120});e.widthColumnName=ko.computed(function(){return e.width()-24-e.widthColumnUp()-e.widthColumnDown()-e.widthColumnEvents()});e.rangeid=ko.observable(0);e.shouldShowDateInput=ko.observable(false);e.range=ko.observable("Please click the gear icon to select a range");e.uptime=ko.observable("N/A");e.downtime=ko.observable("N/A");e.updateInProgress=ko.observable(false);e.datefrom=ko.observable(null);e.dateto=ko.observable(null);e.loadData=function(){if(!e.updateInProgress()){if(e.rangeid()!=12||(e.datefrom()&&e.dateto())){var j=-1;e.updateInProgress(true);if(!ISPHONE){j=setTimeout("$('#spinner').show()",350)}e.myDataTable.getDataSource().sendRequest("range="+e.rangeid()+"&datefrom="+e.datefrom()+"&dateto="+e.dateto(),{success:function(l,k,m){clearTimeout(j);e.updateInProgress(false);e.myDataTable.onDataReturnReplaceRows(l,k,m)},failure:function(l,k,m){clearTimeout(j);e.updateInProgress(false);MMONIT.error.show("Update error. HTTP status code ["+k.status+"]")}})}}};e.rangeUpdate=function(l,j,k){k.stopPropagation();if(l==12){if(!$(k.target).parents(".dateInputBox").length){e.shouldShowDateInput(!e.shouldShowDateInput())}}else{e.shouldShowDateInput(false);$.post(b.homepath+"session/delete?key=uDateFrom&key=uDateTo").error(MMONIT.error.json)}if(e.rangeid()!=l){e.rangeid(l);$(".pagination .active").removeClass("active");$(".range"+l).addClass("active");e.datefrom(null);e.dateto(null);$("#datefrom").datepicker("setValue",new Date());$("#dateto").datepicker("setValue",new Date());$.post(b.homepath+"session/put","uRange="+e.rangeid()).error(MMONIT.error.json);e.loadData()}else{if(l==12&&!e.shouldShowDateInput()){e.loadData()}}};e.showSearch=ko.observable(false);e.init=function(){$.ajax({url:b.homepath+"session/get?key=uRange&key=uDateFrom&key=uDateTo",async:false,dataType:"json",error:MMONIT.error.json,success:function(j){if(j){if(j.uRange){e.rangeid(j.uRange)}if(j.uDateFrom&&j.uDateFrom!=="null"){e.datefrom(j.uDateFrom)}if(j.uDateTo&&j.uDateTo!=="null"){e.dateto(j.uDateTo)}}$("#datefrom").datepicker({weekStart:1}).datepicker("setValue",e.datefrom()?new Date(e.datefrom()*1000):new Date()).on("changeDate",function(l){var k=parseInt(l.date.valueOf())/1000;if(!e.dateto()||k<e.dateto()){e.datefrom(k)}else{MMONIT.error.show("DateFrom must be before or equal to DateTo")}$("#datefrom").datepicker("hide")});$("#dateto").datepicker({weekStart:1}).datepicker("setValue",e.dateto()?new Date(e.dateto()*1000):new Date()).on("changeDate",function(m){var l=parseInt(m.date.valueOf())/1000+86399;var k=(new Date(new Date().getTime()+24*60*60*1000))/1000;if(k<l){MMONIT.error.show("DateTo is set into the future and nobody knows what the future will bring")}else{if(!e.datefrom()||l>e.datefrom()){e.dateto(l);$("#dateto").datepicker("hide")}else{MMONIT.error.show("DateTo must be later or equal to DateFrom")}}});$(".pagination .active").removeClass("active");$(".range"+e.rangeid()).addClass("active")}})}();e.datefrom.subscribe(function(j){$.post(b.homepath+"session/put","uDateFrom="+e.datefrom()).error(MMONIT.error.json)});e.dateto.subscribe(function(j){$.post(b.homepath+"session/put","uDateTo="+e.dateto()).error(MMONIT.error.json)});e.datefromLabel=ko.computed(function(){var j;if(e.datefrom()){var k=new Date(e.datefrom()*1000);j="From: "+k.toDateString().substr(4)}else{j="Date From"}return j});e.datetoLabel=ko.computed(function(){var j;if(e.dateto()){var k=new Date(e.dateto()*1000);j="To: "+k.toDateString().substr(4)}else{j="Date To"}return j});var g;if(b.hostid){g=new YAHOO.util.XHRDataSource(b.homepath+"reports/uptime/get?id="+b.hostid)}else{g=new YAHOO.util.XHRDataSource(b.homepath+"reports/uptime/list")}g.connMethodPost=true;g.connXhrMode="cancelStaleRequests";g.connTimeout=30000;g.responseType=YAHOO.util.XHRDataSource.TYPE_JSON;g.responseSchema={resultsList:"items",fields:[{key:"id",parser:"number"},{key:"active",parser:"number"},{key:"name",parser:"string"},{key:"uptime",parser:"number"},{key:"downtime",parser:"string"},{key:"events",parser:"number"}],metaFields:{Range:"range",DateFrom:"datefrom",DateTo:"dateto",Uptime:"uptime",Downtime:"downtime"}};var c=function(k,j,l,m){$(k).text(j.getData("name"));if(!parseInt(j.getData("active"),10)){YAHOO.util.Dom.addClass(this.getTrEl(k),"light-grey")}};var d=function(k,j,l,m){$(k).text(j.getData("uptime")+"%")};var i=function(m,l,n,o){if(parseInt(l.getData("events"))>0){var j=e.datefrom()?e.datefrom():b.dateFrom;var k=e.dateto()?e.dateto():b.dateTo;if(b.hostid){$(m).html('<a href="'+b.homepath+"reports/events/?reset=true&host="+encodeURIComponent(b.host)+"&datefrom="+j+"&dateto="+k+"&servicenameid="+l.getData("id")+'">'+l.getData("events")+"</a>")}else{$(m).html('<a href="'+b.homepath+"reports/events/?reset=true&host="+encodeURIComponent(l.getData("name"))+"&datefrom="+j+"&dateto="+k+"&servicenameid="+b.monit+'&eventtype=1048576">'+l.getData("events")+"</a>")}}else{$(m).text(l.getData("events"))}};var h=[{key:"name",label:b.columnLabel,sortable:true,formatter:c},{key:"uptime",label:"Up",sortable:true,formatter:d},{key:"downtime",label:"Down",sortable:false,formatter:"text"},{key:"events",label:"Events",sortable:true,formatter:i}];var f={initialLoad:(e.rangeid()!=12||(e.datefrom()&&e.dateto()))?true:false,initialRequest:"range="+e.rangeid()+"&datefrom="+e.datefrom()+"&dateto="+e.dateto(),selectionMode:"single",sortedBy:{key:"uptime",dir:YAHOO.widget.DataTable.CLASS_ASC}};e.myDataTable=new YAHOO.widget.DataTable("mytable",h,g,f);if(b.rowsclickable){if(!(ISPHONE||ISTABLET)){e.myDataTable.subscribe("rowMouseoverEvent",e.myDataTable.onEventHighlightRow);e.myDataTable.subscribe("rowMouseoutEvent",e.myDataTable.onEventUnhighlightRow)}e.myDataTable.subscribe("cellClickEvent",function(l){var j=e.myDataTable.getColumn(l.target);var k=e.myDataTable.getRecord(l.target);if(ISTABLET&&j.key=="events"&&k.getData("events")>0){window.location=b.homepath+"reports/events/?host="+encodeURIComponent(b.hostid?b.host:k.getData("name"))+"&datefrom="+b.dateFrom+"&servicenameid="+(b.hostid?k.getData("id"):b.monit)}else{window.location=MMONIT.ui.location("host/"+e.myDataTable.getRecord(l.target).getData("id"))}})}e.myDataTable.doBeforeLoadData=function(j,k,m){$("#spinner").hide();if(k.error){MMONIT.error.json(k,null,null,e.myDataTable);return false}var l=k.meta;b.dateFrom=l.DateFrom;b.dateTo=l.DateTo;e.range(strftime("%B %d %Y",new Date(b.dateFrom*1000))+" - "+strftime("%B %d %Y",new Date(b.dateTo*1000)));e.uptime(l.Uptime);e.downtime(l.Downtime);e.showSearch(k.results.length>15);k.results.sort(function(o,n){return parseFloat(o.uptime)-parseFloat(n.uptime)});e.myDataTable.set("sortedBy",{key:"uptime",dir:YAHOO.widget.DataTable.CLASS_ASC});MMONIT.datatable.search.shouldApplyClientSearch=true;MMONIT.datatable.search.shouldRefreshCache=true;return true};MMONIT.datatable.search.client(e.myDataTable,"name","searchField");if(!f.initialLoad){$("#spinner").hide()}e.resize=function(){var k=e.myDataTable.getColumn("name");var j=e.myDataTable.getColumn("uptime");var m=e.myDataTable.getColumn("downtime");var l=e.myDataTable.getColumn("events");e.myDataTable.setColumnWidth(k,e.widthColumnName());e.myDataTable.setColumnWidth(j,e.widthColumnUp());e.myDataTable.setColumnWidth(m,e.widthColumnDown());e.myDataTable.setColumnWidth(l,e.widthColumnEvents());if(e.isPhone()){e.myDataTable.hideColumn(l);if(e.isPortrait()){e.myDataTable.hideColumn(m);e.myDataTable.reorderColumn(m,1)}else{e.myDataTable.showColumn(m);e.myDataTable.reorderColumn(m,3)}e.myDataTable.reorderColumn(l,1)}else{e.myDataTable.showColumn(m);e.myDataTable.showColumn(l);e.myDataTable.reorderColumn(m,2);e.myDataTable.reorderColumn(l,3)}};e.resize()};ko.applyBindings(a);$(document).on("vclick",function(c){if(a.shouldShowDateInput()){a.shouldShowDateInput(false);a.loadData()}$(".datepicker").hide()});$(window).on("resize orientationchange",function(c){a.width($("#main").outerWidth());a.height($(window).outerHeight());a.resize()})}}}();